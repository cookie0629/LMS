# 目录与文件功能详解（LightweightMusicServer）

> 说明：项目基于 C++/CMake（Wt WebToolkit）实现的轻量音乐服务器。下文按目录自顶向下梳理功能，并给出每个源文件、配置文件的作用。`build/` 中的内容为 CMake/编译自动生成的缓存与目标文件，已在专节汇总说明，不逐条重复。

## 根目录
- `.envrc`：direnv 环境配置。
- `.gitignore`：Git 忽略规则。
- `CMakeLists.txt`：顶层 CMake 构建入口。
- `README.md`：英文项目说明。
- `使用说明.md`：中文使用文档。
- `filelist.txt`：本次生成的完整文件清单（辅助说明用）。
- `music/张杰 - 明天过后.mp3`：示例音乐文件。

## approot/（Wt 模板与翻译资源）
- `main.xml`：应用主模板。
- `login.xml`：登录页面。
- `mediaplayer.xml`：媒体播放器视图。
- `playqueue.xml`：播放队列视图。
- `explore.xml`：浏览/发现页。
- `artist.xml`、`artists.xml`、`release.xml`、`releases.xml`、`tracklist.xml`、`tracklists.xml`、`tracks.xml`：对应艺术家、专辑、曲目、曲单等页面模板。
- `settings.xml`：设置页。
- `misc.xml`：其他公共片段。
- `notifications.xml`：通知区域模板。
- `error.xml`：错误页。
- `admin-*.xml`（about/db/debugtools/initwizard/medialibraries/medialibrary/scannercontroller/scansettings/tracing/user/users）：后台管理各子页面模板。
- `messages*.xml`（含 messages.xml、messages_zh.xml 等多语言文件）：界面文本翻译。
- `images/unknown-artist.svg`、`images/unknown-cover.svg`：默认占位图。

## cmake/modules/
- `FindFilesystem.cmake`：C++17 filesystem 兼容性查找。
- `FindPAM.cmake`：Pluggable Authentication Modules 依赖探测。
- `FindStbImage.cmake`：stb_image/stb_image_write/stb_image_resize 查找。

## conf/
- `lms.conf`：运行时配置（示例/默认）。
- `lms.conf.example`：配置样例。
- `pam/lms`：PAM 服务配置。
- `systemd/default.service`：systemd 服务单元模板。

## docroot/（静态资源）
- `css/bootstrap.solar.min.css`：Bootstrap Solar 主题。
- `css/lms.css`：项目自定义样式。
- `js/bootstrap.bundle.min.js`：前端 Bootstrap 依赖。
- `js/mediaplayer.js`：前端播放器脚本。

## scripts/（构建与环境脚本）
- `build.sh`：一键构建。
- `check-dependencies.sh`：依赖检查。
- `complete-wt-setup.sh`：Wt 环境补充配置。
- `configure-project.sh`：项目 CMake 配置包装。
- `install-wt.sh`：安装 Wt 相关依赖。
- `setup-environment.sh`：开发环境初始化。

## var/（运行时数据）
- `lms.db`、`lms.db-shm`、`lms.db-wal`：SQLite 数据库及其 WAL。
- `wt_config.xml`：Wt 运行配置。

## build/（自动生成产物）
- 顶层 `CMakeCache.txt`、`cmake_install.cmake`、`CTestTestfile.cmake`、`DartConfiguration.tcl`、`Makefile`：CMake 配置/测试/安装/构建脚本。
- `CMakeFiles/`：大量 CTest/CMake 中间文件、依赖描述、进度标记。
- `3.28.3/CompilerId*`：C/C++ 编译器探测源码与可执行文件。
- `src/`、`src/libs/`、`src/lms/` 等子目录下的 `*.a`、`*.o`、`*.o.d`、`build.make`、`DependInfo.cmake` 等：各模块的静态库、目标文件、依赖/链接描述；`cmake_install.cmake` 与 `CTestTestfile.cmake` 为对应子项目安装与测试元数据。
- 结论：`build/` 全部为编译生成，功能等同其源文件所在模块，通常不需手工修改。

## src/（核心源码）
### CMake 列表
- `CMakeLists.txt`、`libs/CMakeLists.txt`、`lms/CMakeLists.txt`、各子库 `CMakeLists.txt`：定义构建目标、依赖与安装规则。

### libs/audio/（音频解码、标签、转码）
- `impl/AudioFileInfo.cpp`、`AudioTypes.cpp`、`ImageReader.cpp`、`ParseAudioFileInfo.cpp`、`TagReader.cpp`：音频元数据读取、标签解析、封面读取入口实现。
- `impl/ffmpeg/AudioFile*.{cpp,hpp}`：基于 FFmpeg 的音频读取与信息抽取。
- `impl/ffmpeg/ImageReader.{cpp,hpp}`：使用 FFmpeg 读取封面图。
- `impl/ffmpeg/TagReader.{cpp,hpp}`：基于 FFmpeg 读取标签。
- `impl/ffmpeg/Transcoder.{cpp,hpp}`：转码实现。
- `impl/ffmpeg/Utils.{cpp,hpp}`：FFmpeg 辅助方法。
- `impl/taglib/AudioFileInfo.{cpp,hpp}`、`ImageReader.{cpp,hpp}`、`TagReader.{cpp,hpp}`、`Utils.{cpp,hpp}`、`TagLibDefs.hpp`：基于 TagLib 的标签/封面解析实现。
- `include/audio/AudioProperties.hpp`：音频属性定义。
- `include/audio/AudioTypes.hpp`：音频通用类型。
- `include/audio/Exception.hpp`：音频模块异常。
- `include/audio/IAudioFileInfo.hpp`、`IImageReader.hpp`、`ITagReader.hpp`、`ITranscoder.hpp`：接口定义。
- `include/audio/TranscodeTypes.hpp`：转码选项/结果类型。

### libs/core/（基础设施与工具）
- `impl/ArchiveZipper.{cpp,hpp}`：压缩/打包实现。
- `impl/ChildProcess.{cpp,hpp}`、`ChildProcessManager.{cpp,hpp}`：子进程管理。
- `impl/Config.{cpp,hpp}`：配置解析实现。
- `impl/FileResourceHandler.{cpp,hpp}`：文件资源处理。
- `impl/IOContextRunner.cpp`：异步 IO 运行器。
- `impl/JobScheduler.{cpp,hpp}`：任务调度器。
- `impl/Logger.{cpp,hpp}`：日志实现。
- `impl/MimeTypes.cpp`：MIME 类型映射。
- `impl/NetAddress.cpp`：网络地址封装。
- `impl/PartialDateTime.cpp`：部分日期时间处理。
- `impl/Path.cpp`：路径封装。
- `impl/Random.cpp`：随机工具。
- `impl/RecursiveSharedMutex.cpp`：递归共享互斥。
- `impl/String.cpp`：字符串工具。
- `impl/TraceLogger.{cpp,hpp}`：跟踪日志实现。
- `impl/UUID.cpp`：UUID 工具。
- `impl/Version.cpp.in`：版本模板源。
- `impl/XxHash3.cpp`：哈希实现。
- `impl/http/Client.{cpp,hpp}`、`ClientRequest.hpp`、`SendQueue.{cpp,hpp}`：HTTP 客户端与发送队列。
- `include/core/*`（Crc32Calculator、EnumSet、Exception、FileResourceHandlerCreator、I* 接口、LiteralString、MimeTypes、NetAddress、PartialDateTime、Path、Random、RecursiveSharedMutex、Service、SizeLiterals、String、SystemPaths、TaggedType、Tuple、Utils、UUID、Version、XxHash3、ZipperResourceHandlerCreator、http/ClientRequestParameters、http/IClient）：公共类型、接口与工具声明。

### libs/database/（数据访问与 ORM）
- `impl/Db.{cpp,hpp}`：数据库句柄封装。
- `impl/IdType.cpp`：ID 类型实现。
- `impl/Migration.{cpp,hpp}`：迁移执行。
- `impl/Object.cpp`：基类实现。
- `impl/QueryPlanRecorder.{cpp,hpp}`：查询计划记录。
- `impl/Session.cpp`：会话封装。
- `impl/SqlQuery.{cpp,hpp}`：SQL 查询包装。
- `impl/Transaction.cpp`、`TransactionChecker.{cpp,hpp}`：事务管理/检测。
- `impl/Types.cpp`：数据库通用类型实现。
- `impl/Utils.{cpp,hpp}`：辅助函数。
- `impl/objects/*.cpp`（Artist, ArtistInfo, Artwork, AuthToken, Cluster, Directory, Image, Listen, MediaLibrary, Medium, PlayListFile, PlayQueue, Podcast, PodcastEpisode, RatedArtist, RatedRelease, RatedTrack, Release, ScanSettings, StarredArtist, StarredRelease, StarredTrack, Track, TrackArtistLink, TrackBookmark, TrackEmbeddedImage, TrackEmbeddedImageLink, TrackFeatures, TrackList, TrackLyrics, UIState, User）：ORM 对象实现。
- `impl/traits/*.hpp`（EnumSetTraits, IdTypeTraits, ImageHashTypeTraits, PartialDateTimeTraits, PathTraits, StringViewTraits）：类型与字段 traits。
- `include/database/*`（IDb, IdRange, IdType, IQueryPlanRecorder, Migration, Object, Session, Transaction, Types, Utils）：接口/类型声明。
- `include/database/objects/*.hpp`：所有数据库实体及其 Id 类型、过滤器声明（与上面 .cpp 对应）。

### libs/image/（图片处理）
- `impl/EncodedImage.{cpp,hpp}`：编码图片实现。
- `impl/graphicsmagick/Image.cpp`、`RawImage.{cpp,hpp}`：GraphicsMagick 版本的图像处理。
- `impl/stb/Exception.{cpp,hpp}`、`Image.cpp`、`RawImage.{cpp,hpp}`、`StbImage.{cpp,hpp}`、`StbImageResize.{cpp,hpp}`、`StbImageWrite.{cpp,hpp}`：基于 stb 的解码/缩放/写入。
- `include/image/*`（EncodedImage, Exception, IEncodedImage, Image, IRawImage, Types）：接口与公共类型。

### libs/services/（业务服务层）
#### artwork/
- `impl/ArtworkService.{cpp,hpp}`：封面服务实现。
- `impl/ImageCache.{cpp,hpp}`：封面缓存。
- `include/services/artwork/IArtworkService.hpp`：接口。

#### auth/
- `impl/AuthService.cpp`：对外认证入口。
- `impl/AuthServiceBase.{cpp,hpp}`：通用认证基类。
- `impl/AuthTokenService.{cpp,hpp}`：Token 管理。
- `impl/EnvService.cpp`：环境变量取用。
- `impl/LoginThrottler.{cpp,hpp}`：登录节流。
- `impl/PasswordService.cpp`：密码服务封装。
- `impl/PasswordServiceBase.{cpp,hpp}`：密码处理基类。
- `impl/http-headers/HttpHeadersEnvService.{cpp,hpp}`：从 HTTP 头提取环境。
- `impl/internal/InternalPasswordService.{cpp,hpp}`：内置密码后端。
- `impl/pam/PAMPasswordService.{cpp,hpp}`：PAM 后端。
- `include/services/auth/*`（IAuthTokenService, IEnvService, IPasswordService, Types）：接口与类型。

#### feedback/
- `impl/FeedbackService.{cpp,hpp,impl.hpp}`：用户反馈/评分服务。
- `impl/IFeedbackBackend.hpp`：反馈后端接口。
- `impl/internal/InternalBackend.{cpp,hpp}`：内部存储实现。
- `impl/listenbrainz/*`（Exception, FeedbacksParser.{cpp,hpp}, FeedbacksSynchronizer.{cpp,hpp}, FeedbackTypes.{cpp,hpp}, ListenBrainzBackend.{cpp,hpp}, Utils.{cpp,hpp}）：ListenBrainz 集成。
- `include/services/feedback/*`（Exception, IFeedbackService）：接口与异常。

#### podcast/
- `impl/Executor.{cpp,hpp}`：刷新执行器。
- `impl/PodcastParsing.{cpp,hpp}`：播客 RSS/Atom 解析。
- `impl/PodcastService.{cpp,hpp}`：服务实现。
- `impl/PodcastTypes.hpp`：播客模型定义。
- `impl/RefreshContext.hpp`：刷新上下文。
- `impl/steps/*`（CheckForMissingFilesStep, ClearTmpDirectoryStep, DownloadEpisodeArtworksStep, DownloadEpisodesStep, DownloadPodcastArtworksStep, RefreshPodcastsStep, RefreshStep, RemoveEpisodesStep, RemovePodcastsStep, Utils.{cpp,hpp}）：分步刷新流程。
- `include/services/podcast/IPodcastService.hpp`：接口。

#### recommendation/
- `impl/IEngine.hpp`：推荐引擎接口。
- `impl/ClustersEngineCreator.hpp`、`FeaturesEngineCreator.hpp`：引擎工厂。
- `impl/PlaylistGeneratorService.{cpp,hpp}`：播放列表生成。
- `impl/RecommendationService.{cpp,hpp}`：推荐服务。
- `impl/clusters/ClustersEngine.{cpp,hpp}`：聚类推荐。
- `impl/features/*`（FeaturesDefs, FeaturesEngine.{cpp,hpp}, FeaturesEngineCache.{cpp,hpp}）：特征生成与缓存。
- `impl/playlist-constraints/*`（ConsecutiveArtists.{cpp,hpp}, ConsecutiveReleases.{cpp,hpp}, DuplicateTracks.{cpp,hpp}, IConstraint.hpp）：播放列表约束。
- `include/services/recommendation/*`（IPlaylistGeneratorService, IRecommendationService, Types）：接口与类型。

#### scanner/（媒体库扫描）
- `impl/FileScanners.{cpp,hpp}`：扫描调度。
- `impl/MediaLibraryInfo.hpp`、`ScanContext.hpp`、`ScannerSettings.hpp`、`ScannerStats.cpp`：扫描上下文与统计。
- `impl/ScannerService.{cpp,hpp}`、`ScannerServiceTraceLogger.cpp`：服务实现与追踪。
- `impl/helpers/ArtistHelpers.{cpp,hpp}`：艺术家数据辅助。
- `impl/scanners/*`：各类文件扫描器
  - 公共：`FileScanOperationBase.{cpp,hpp}`、`FileToScan.hpp`、`IFileScanner.hpp`、`IFileScanOperation.hpp`、`Utils.{cpp,hpp}`。
  - `artistinfo/ArtistInfoFileScanner.{cpp,hpp}`、`ArtistInfoParser.{cpp,hpp}`。
  - `audiofile/AudioFileScanner.{cpp,hpp}`、`AudioFileScanOperation.{cpp,hpp}`、`TrackMetadataParser.{cpp,hpp}`、`Utils.{cpp,hpp}`。
  - `lyrics/LyricsFileScanner.{cpp,hpp}`、`LyricsParser.{cpp,hpp}`。
  - `playlist/PlayListFileScanner.{cpp,hpp}`、`PlayListParser.{cpp,hpp}`。
- `impl/steps/*`：扫描流水线步骤（IScanStep、JobQueue.{cpp,hpp}、ScanErrorLogger.{cpp,hpp}、ScanStepArtistReconciliation、ScanStepAssociateArtistImages、ScanStepAssociateExternalLyrics、ScanStepAssociateMediumImages、ScanStepAssociatePlayListTracks、ScanStepAssociateReleaseImages、ScanStepAssociateTrackImages、ScanStepBase、ScanStepCheckForDuplicatedFiles、ScanStepCheckForRemovedFiles、ScanStepCompact、ScanStepComputeClusterStats、ScanStepOptimize、ScanStepRemoveOrphanedDbEntries、ScanStepScanFiles、ScanStepUpdateLibraryFields；均有 cpp/hpp）。
- `impl/types/*`（ArtistInfo, Lyrics, PlayList, TrackMetadata）：扫描产生的临时数据类型。
- `include/services/scanner/*`（IScannerService, ScanErrors, ScannerEvents, ScannerOptions, ScannerStats）：对外接口/事件/配置。

#### scrobbling/
- `impl/IScrobblingBackend.hpp`：后端接口。
- `impl/ScrobblingService.{cpp,hpp}`：服务实现。
- `impl/internal/InternalBackend.{cpp,hpp}`：内部存储实现。
- `impl/listenbrainz/*`（Exception, ListenBrainzBackend.{cpp,hpp}, ListensParser.{cpp,hpp}, ListensSynchronizer.{cpp,hpp}, ListenTypes.{cpp,hpp}, Utils.{cpp,hpp}）：ListenBrainz 同步。
- `include/services/scrobbling/*`（Exception, IScrobblingService, Listen.hpp）：接口与数据结构。

#### transcoding/
- `impl/TranscodeResourceHandler.{cpp,hpp}`：转码 HTTP 资源处理。
- `impl/TranscodeService.{cpp,hpp}`：转码服务。
- `include/services/transcoding/*`（Exception, ITranscodeService）：接口定义。

#### som/（自组织映射网络，用于特征/聚类）
- `impl/DataNormalizer.cpp`、`impl/Network.cpp`：SOM 算法实现。
- `include/som/*`（DataNormalizer, InputVector, Matrix, Network）：接口与类型。

#### subsonic/（Subsonic API 兼容层）
- 核心：`impl/CoverArtId.{cpp,hpp}`、`ParameterParsing.{cpp,hpp}`、`ProtocolVersion.{cpp,hpp}`、`RequestContext.{cpp,hpp}`、`ResponseFormat.{cpp,hpp}`、`SubsonicId.{cpp,hpp}`、`SubsonicResource.{cpp,hpp}`、`SubsonicResourceConfig.{cpp,hpp}`、`SubsonicResponse.{cpp,hpp}`、`SubsonicResponseAllocator.hpp`、`TLSMonotonicMemoryResource.hpp`。
- 端点 `impl/endpoints/*.cpp/hpp`：AlbumSongLists、Bookmarks、Browsing、MediaAnnotation、MediaLibraryScanning、MediaRetrieval、Playlists、Podcast、Searching、System、UserManagement。
- 响应模型 `impl/responses/*.cpp/hpp`：Album、AlbumInfo、Artist、Bookmark、Contributor、DiscTitle、Genre、ItemDate、ItemGenre、Lyrics、Playlist、Podcast、RecordLabel、ReplayGain、Song、User。
- `include/subsonic/SubsonicResource.hpp`：公共接口。

### lms/（应用可执行与 UI）
- `main.cpp`：应用入口。
- `ui/Auth.{cpp,hpp}`：登录流程。
- `ui/LmsApplication.{cpp,hpp}`、`LmsApplicationException.hpp`、`LmsApplicationManager.{cpp,hpp}`、`LmsInitApplication.{cpp,hpp}`：应用生命周期管理、初始化。
- `ui/LmsTheme.{cpp,hpp}`：主题配置。
- `ui/MediaPlayer.{cpp,hpp}`：前端播放器交互。
- `ui/ModalManager.{cpp,hpp}`：模态框控制。
- `ui/Notification.{hpp}`、`NotificationContainer.{cpp,hpp}`：通知模型与容器。
- `ui/PlayQueue.{cpp,hpp}`：播放队列视图逻辑。
- `ui/SettingsView.{cpp,hpp}`：设置界面。
- `ui/State.{cpp,hpp}`：全局 UI 状态。
- `ui/Tooltip.{cpp,hpp}`：提示组件。
- `ui/Utils.{cpp,hpp}`：界面辅助函数。
- `ui/admin/*`：后台页面逻辑
  - About, DebugToolsView, InitWizardView, MediaLibrariesView, MediaLibraryModal, ScannerController, ScannerReportResource, ScanSettingsView, UsersView, UserView（均 cpp/hpp）。
  - `admin/debug/Database.{cpp,hpp}`、`Tracing.{cpp,hpp}`：调试工具。
- `ui/common/*`：通用组件与校验
  - DoubleValidator, InfiniteScrollingContainer, LoadingIndicator, LoginNameValidator, MandatoryValidator, PasswordValidator, Template, UppercaseValidator, UUIDValidator（均 cpp/hpp），`ValueStringModel.hpp`。
- `ui/explore/*`：媒体浏览页面
  - ArtistCollector, ArtistListHelpers, ArtistsView, ArtistView, DatabaseCollectorBase, Explore, Filters, PlayQueueController, ReleaseCollector, ReleaseHelpers, ReleasesView, ReleaseTypes, ReleaseView, SortModeSelector, TrackArtistLinkTypeSelector, TrackCollector, TrackListHelpers, TrackListsView, TrackListView, TracksView（对应 cpp/hpp）。
- `ui/resource/*`：HTTP 资源
  - ArtworkResource, AudioFileResource, AudioTranscodingResource, DownloadResource（均 cpp/hpp）。

## 其他
- `CMakeFiles/CMakeSystem.cmake`：顶层 CMake 系统探测结果。

---

如需进一步深入某个模块的实现细节，可结合对应 `.cpp/.hpp` 文件查看。当前文档覆盖了源文件与配置文件；`build/` 中的中间文件与产物已整体说明。***

