# LMS 模板项目架构分析

## 📋 目录
1. [整体架构](#整体架构)
2. [核心模块分析](#核心模块分析)
3. [技术栈总结](#技术栈总结)
4. [设计模式识别](#设计模式识别)
5. [数据流分析](#数据流分析)

---

## 整体架构

### 架构层次

```
┌─────────────────────────────────────────┐
│         Web UI Layer (Wt)                │
│  - LmsApplication (主应用)                │
│  - LmsInitApplication (初始化向导)        │
│  - Explore (浏览界面)                    │
│  - Admin (管理界面)                      │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         Service Layer (业务服务)          │
│  - ScannerService (扫描服务)             │
│  - AuthService (认证服务)                │
│  - TranscodeService (转码服务)            │
│  - RecommendationService (推荐服务)      │
│  - ScrobblingService (播放记录)          │
│  - ArtworkService (封面服务)             │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         Core Libraries (核心库)          │
│  - Database (数据库层)                   │
│  - Audio (音频处理)                      │
│  - Image (图像处理)                      │
│  - Core (核心工具)                       │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         External Libraries               │
│  - Wt (Web框架)                          │
│  - FFmpeg (音频处理)                     │
│  - TagLib (标签读取)                     │
│  - SQLite (数据库)                       │
└─────────────────────────────────────────┘
```

### 目录结构分析

```
模板/
├── src/
│   ├── libs/              # 核心库（可复用的模块）
│   │   ├── core/          # 核心工具库
│   │   ├── database/      # 数据库抽象层
│   │   ├── audio/         # 音频处理库
│   │   ├── image/         # 图像处理库
│   │   ├── services/      # 业务服务（依赖 core 和 database）
│   │   ├── som/           # 自组织映射（推荐算法）
│   │   └── subsonic/      # Subsonic API 实现
│   ├── lms/               # 主程序
│   │   ├── main.cpp       # 程序入口
│   │   └── ui/            # Web UI 实现
│   └── tools/             # 工具程序
├── approot/               # Wt XML 模板
├── docroot/               # 静态资源（CSS, JS）
└── conf/                  # 配置文件
```

---

## 核心模块分析

### 1. Core 库 (`libs/core/`)

**职责**：提供基础工具和基础设施

**核心组件**：
- **IConfig** - 配置管理接口
- **ILogger** - 日志系统接口
- **Path** - 路径处理工具
- **String** - 字符串工具
- **UUID** - UUID 生成
- **Service** - 服务定位器模式
- **JobScheduler** - 任务调度器
- **ChildProcessManager** - 子进程管理
- **IOContextRunner** - IO 上下文运行器（异步操作）

**设计特点**：
- 使用接口（I 前缀）定义抽象
- 使用 Service 模式实现依赖注入
- 提供工具类而非业务逻辑

### 2. Database 库 (`libs/database/`)

**职责**：数据库抽象层和 ORM

**核心组件**：
- **IDb** - 数据库接口
- **Session** - 数据库会话
- **objects/** - 数据对象（Track, Artist, Release, User 等）
- **Migration** - 数据库迁移

**数据模型关系**：
```
Track (曲目)
  ├── Artist (艺术家) - 多对多关系
  ├── Release (专辑)
  │   └── Medium (介质/CD)
  ├── Cluster (标签) - 多对多关系
  └── User (用户) - 播放列表、收藏等
```

**设计特点**：
- 使用 Wt::Dbo ORM
- 对象关系映射清晰
- 支持数据库迁移

### 3. Audio 库 (`libs/audio/`)

**职责**：音频文件解析和元数据提取

**核心组件**：
- **IAudioFileInfo** - 音频文件信息接口
- **ITagReader** - 标签读取接口
- **IImageReader** - 图像读取接口
- **impl/taglib/** - TagLib 实现
- **impl/ffmpeg/** - FFmpeg 实现

**设计特点**：
- 接口与实现分离
- 支持多种解析器（TagLib 优先，FFmpeg 备用）
- 统一的接口抽象

### 4. Services 库 (`libs/services/`)

**职责**：业务逻辑服务

#### 4.1 Scanner Service
- **功能**：扫描文件系统，解析音频文件，更新数据库
- **流程**：目录遍历 → 文件识别 → 元数据提取 → 数据库更新

#### 4.2 Auth Service
- **功能**：用户认证和授权
- **支持**：Internal（数据库）、PAM、HTTP Headers

#### 4.3 Transcode Service
- **功能**：音频转码（使用 FFmpeg）
- **场景**：格式转换、比特率调整

#### 4.4 Recommendation Service
- **功能**：基于标签的推荐
- **算法**：使用 SOM（自组织映射）

#### 4.5 Scrobbling Service
- **功能**：播放记录和同步（ListenBrainz）

#### 4.6 Artwork Service
- **功能**：封面图片管理

### 5. UI 层 (`lms/ui/`)

**职责**：Web 界面实现

**核心组件**：
- **LmsApplication** - 主应用类
- **LmsInitApplication** - 初始化向导
- **Explore** - 浏览界面（艺术家、专辑、曲目）
- **Admin** - 管理界面
- **MediaPlayer** - 媒体播放器
- **PlayQueue** - 播放队列

**设计特点**：
- 使用 Wt 框架的服务器端渲染
- XML 模板定义 UI
- JavaScript 处理客户端交互

### 6. Subsonic API (`libs/subsonic/`)

**职责**：实现 Subsonic/OpenSubsonic API

**设计特点**：
- RESTful API
- 端点模块化（endpoints/）
- 响应对象化（responses/）

---

## 技术栈总结

### 核心框架
- **Wt 4.12+** - C++ Web 框架
- **Wt::Dbo** - ORM 框架
- **SQLite3** - 数据库

### 音频处理
- **TagLib 2.1+** - 标签读取
- **FFmpeg 4.0+** - 音频解码和转码

### 图像处理
- **STB Image** 或 **GraphicsMagick** - 图像处理

### 其他依赖
- **Boost** - 程序选项、文件系统、IO 流
- **PugiXML** - XML 解析
- **OpenSSL** - 加密和 TLS
- **libconfig++** - 配置文件解析

---

## 设计模式识别

### 1. 接口模式（Interface Pattern）
- 所有核心功能都定义接口（I 前缀）
- 实现与接口分离
- 便于测试和替换实现

### 2. 服务定位器模式（Service Locator）
- `core::Service<T>` 模板类
- 全局服务注册和获取
- 依赖注入

### 3. 工厂模式（Factory Pattern）
- 通过工厂函数创建对象
- 例如：`createAudioFileInfo()`

### 4. 策略模式（Strategy Pattern）
- 多种解析器实现（TagLib vs FFmpeg）
- 多种认证后端（Internal vs PAM）

### 5. 观察者模式（Observer Pattern）
- 扫描事件通知
- 播放状态更新

---

## 数据流分析

### 1. 扫描流程

```
文件系统
  ↓
ScannerService::scan()
  ↓
遍历目录，识别音频文件
  ↓
AudioFileInfo::parse() (使用 TagLib/FFmpeg)
  ↓
提取元数据（标签、属性）
  ↓
匹配/创建 Artist, Release, Track
  ↓
Database::Session::add() / modify()
  ↓
数据库更新完成
```

### 2. 播放流程

```
Web UI (点击播放)
  ↓
PlayQueue::addTrack()
  ↓
MediaPlayer::play()
  ↓
AudioFileResource::handleRequest()
  ↓
文件系统读取 / TranscodeService (如果需要转码)
  ↓
HTTP 流传输
  ↓
客户端播放
```

### 3. 认证流程

```
用户登录请求
  ↓
AuthService::authenticate()
  ↓
根据配置选择后端：
  - Internal: 数据库验证
  - PAM: 系统 PAM 验证
  - HTTP Headers: 反向代理验证
  ↓
生成 AuthToken
  ↓
创建 Session
```

---

## 关键设计决策

### 1. 为什么使用接口？
- **可测试性**：可以轻松 mock 接口进行测试
- **可扩展性**：可以替换实现而不影响调用者
- **清晰性**：接口明确定义了契约

### 2. 为什么使用 Service Locator？
- **全局访问**：服务可以在任何地方访问
- **延迟初始化**：服务按需创建
- **单例管理**：确保服务唯一实例

### 3. 为什么分离 Core 和 Services？
- **Core**：可复用的基础工具，不依赖业务逻辑
- **Services**：业务逻辑，依赖 Core 和 Database
- **清晰分层**：避免循环依赖

### 4. 为什么使用 Wt::Dbo ORM？
- **类型安全**：C++ 类型系统
- **关系管理**：自动处理对象关系
- **迁移支持**：版本化数据库结构

---

## 学习重点

### 对于新手，建议按以下顺序理解：

1. **Core 库** - 理解基础工具和设计模式
2. **Database 库** - 理解数据模型和 ORM
3. **Audio 库** - 理解音频处理流程
4. **Scanner Service** - 理解核心业务逻辑
5. **UI 层** - 理解 Web 应用结构

### 关键概念

- **接口设计**：如何定义清晰的接口
- **依赖管理**：如何管理模块依赖
- **错误处理**：如何处理异常
- **异步操作**：如何使用异步 IO
- **资源管理**：如何管理内存和资源

---

## 下一步

基于这个分析，我们将制定**从零开始的实现计划**，逐步构建自己的 LMS 项目。

