# LMS 项目学习指南

## 📋 目录
1. [项目概述](#项目概述)
2. [技术栈分析](#技术栈分析)
3. [项目架构分析](#项目架构分析)
4. [目录结构详解](#目录结构详解)
5. [核心模块分析](#核心模块分析)
6. [学习计划](#学习计划)

---

## 项目概述

### 什么是 LMS？
**LMS (Lightweight Music Server)** 是一个**自托管的音乐流媒体服务器**，允许你通过 Web 界面从任何地方访问你的音乐收藏。

### 主要功能
- ✅ **Subsonic/OpenSubsonic API** 支持（兼容多种音乐客户端）
- ✅ **多值标签支持**：流派、情绪、艺术家等
- ✅ **艺术家关系**：作曲家、指挥、作词、混音师等
- ✅ **MusicBrainz 集成**：处理重复的艺术家和专辑名称
- ✅ **ListenBrainz 支持**：同步播放记录和反馈
- ✅ **推荐引擎**：基于标签的智能推荐
- ✅ **多库支持**：管理多个音乐库
- ✅ **音频转码**：兼容性和带宽优化
- ✅ **用户管理**：多种认证后端
- ✅ **播客支持**
- ✅ **播放列表支持**
- ✅ **歌词支持**

---

## 技术栈分析

### 核心语言和标准
- **C++20**：项目使用现代 C++ 标准
- **CMake**：构建系统（最低版本 3.12）

### 主要依赖库

#### 1. **Web 框架**
- **Wt (Web Toolkit) 4.12.1+**
  - 用途：构建 Web 应用和 UI
  - 特点：C++ 原生 Web 框架，支持服务器端渲染
  - 组件：Wt::Wt, Wt::Dbo, Wt::DboSqlite3, Wt::HTTP

#### 2. **数据库**
- **SQLite3**（通过 Wt::Dbo）
  - 用途：存储音乐元数据、用户信息、播放列表等
  - 位置：`/var/lms/lms.db`（默认）

#### 3. **音频处理**
- **FFmpeg 4.0+**
  - 用途：音频解码、转码、格式转换
  - 支持格式：AAC, AC3, ALAC, FLAC, MP3, OGG, WAV, WavPack 等
- **TagLib 2.1.1+**
  - 用途：读取音频文件的元数据（标签）
  - 支持：ID3, Vorbis Comments, APE 等标签格式

#### 4. **图像处理**
- **STB Image**（默认）或 **GraphicsMagick++**
  - 用途：处理专辑封面、艺术家图片
  - 功能：图像解码、编码、缩放

#### 5. **其他核心库**
- **Boost**：程序选项、系统、文件系统、IO 流
- **PugiXML**：XML 解析（配置文件、UI 定义）
- **OpenSSL**：加密和 TLS 支持
- **libarchive**：归档文件处理
- **xxhash**：快速哈希算法
- **libconfig++**：配置文件解析

### 构建工具链
- **编译器**：支持 C++20 的 C++ 编译器（GCC/Clang）
- **CMake**：3.12+
- **pkg-config**：依赖管理

---

## 项目架构分析

### 整体架构模式
LMS 采用**分层架构**和**服务导向架构**：

```
┌─────────────────────────────────────────┐
│         Web UI Layer (Wt)               │
│  (LmsApplication, Admin, Explore)       │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         Service Layer                    │
│  (Scanner, Auth, Transcoding, etc.)     │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         Core Libraries                  │
│  (Database, Audio, Image, Core)        │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         External Libraries              │
│  (FFmpeg, TagLib, SQLite, Wt)          │
└─────────────────────────────────────────┘
```

### 数据流
1. **扫描流程**：
   ```
   文件系统 → Scanner Service → Audio Parser (TagLib/FFmpeg) 
   → Database (SQLite) → Web UI
   ```

2. **播放流程**：
   ```
   Web UI → Database Query → File System → Transcoding (可选) 
   → HTTP Stream → Client
   ```

3. **认证流程**：
   ```
   Client → Auth Service → Database/PAM/HTTP Headers 
   → Auth Token → Session
   ```

---

## 目录结构详解

### 根目录
```
lms/
├── approot/          # Web UI 模板和资源（XML 定义）
├── cmake/            # CMake 模块和查找脚本
├── conf/             # 配置文件
│   ├── lms.conf      # 主配置文件
│   ├── pam/          # PAM 认证配置
│   └── systemd/      # systemd 服务文件
├── docroot/          # 静态 Web 资源
│   ├── css/          # 样式表
│   └── js/           # JavaScript 文件
├── src/              # 源代码
│   ├── libs/         # 核心库
│   ├── lms/          # 主程序
│   └── tools/        # 工具程序
├── CMakeLists.txt    # 主构建文件
├── README.md         # 项目说明
├── INSTALL.md        # 安装指南
└── Dockerfile-*      # Docker 构建文件
```

### 核心源代码结构

#### `src/libs/` - 核心库
```
libs/
├── audio/            # 音频处理
│   ├── include/      # 接口定义
│   └── impl/         # 实现（TagLib, FFmpeg）
├── core/             # 核心工具
│   ├── include/      # 接口（Config, Logger, Path, etc.）
│   └── impl/         # 实现
├── database/         # 数据库层
│   ├── include/      # 数据库对象和接口
│   └── impl/         # 实现（ORM, Migration）
├── image/            # 图像处理
│   ├── include/      # 接口
│   └── impl/         # 实现（STB, GraphicsMagick）
├── services/         # 业务服务
│   ├── scanner/      # 音乐文件扫描服务
│   ├── auth/         # 认证服务
│   ├── transcoding/  # 转码服务
│   ├── recommendation/ # 推荐服务
│   ├── scrobbling/   # 播放记录服务
│   ├── feedback/     # 反馈服务
│   ├── podcast/      # 播客服务
│   └── artwork/      # 封面服务
├── som/              # 自组织映射（推荐算法）
├── subsonic/         # Subsonic API 实现
└── CMakeLists.txt
```

#### `src/lms/` - 主程序
```
lms/
├── main.cpp          # 程序入口
└── ui/               # Web UI
    ├── LmsApplication.cpp/hpp      # 主应用
    ├── LmsInitApplication.cpp/hpp  # 初始化向导
    ├── admin/        # 管理界面
    ├── explore/      # 浏览界面
    ├── common/       # 通用组件
    └── resource/     # 资源处理
```

---

## 核心模块分析

### 1. 数据库模块 (`libs/database/`)

#### 职责
- 提供数据库抽象层
- ORM 映射（使用 Wt::Dbo）
- 数据库迁移
- 查询优化

#### 核心对象
- **Track**：音乐曲目
- **Artist**：艺术家
- **Release**：专辑
- **Medium**：介质（CD/Disc）
- **User**：用户
- **PlayQueue**：播放队列
- **TrackList**：播放列表
- **Listen**：播放记录
- **Cluster**：标签聚类（流派、情绪等）

#### 关键文件
- `IDb.hpp`：数据库接口
- `Session.hpp`：数据库会话
- `objects/*.hpp`：数据对象定义

### 2. 音频处理模块 (`libs/audio/`)

#### 职责
- 解析音频文件
- 读取音频属性（时长、比特率、采样率等）
- 读取元数据标签
- 提取嵌入图像

#### 实现方式
- **TagLib**：主要解析器（支持 ID3, Vorbis Comments 等）
- **FFmpeg**：备用解析器和音频属性读取

#### 关键接口
- `IAudioFileInfo.hpp`：音频文件信息接口
- `ITagReader.hpp`：标签读取接口
- `IImageReader.hpp`：图像读取接口

### 3. 扫描服务 (`libs/services/scanner/`)

#### 职责
- 扫描文件系统查找音乐文件
- 解析音频文件元数据
- 更新数据库
- 检测文件变化（新增、删除、修改）

#### 工作流程
1. 扫描配置的媒体库目录
2. 识别音频文件（通过扩展名）
3. 解析每个文件的元数据
4. 匹配艺术家、专辑、曲目
5. 处理重复和关联
6. 更新数据库

#### 关键接口
- `IScannerService.hpp`：扫描服务接口
- `ScannerEvents.hpp`：扫描事件（开始、进度、完成）

### 4. 转码服务 (`libs/services/transcoding/`)

#### 职责
- 实时音频转码
- 格式转换（FLAC → MP3, etc.）
- 比特率调整
- 使用 FFmpeg 进行转码

#### 使用场景
- 客户端不支持原始格式
- 带宽优化
- 移动设备播放

### 5. Web UI (`lms/ui/`)

#### 架构
- **Wt Framework**：服务器端渲染
- **XML 模板**：UI 定义（`approot/*.xml`）
- **JavaScript**：客户端交互（`docroot/js/`）

#### 主要界面
- **登录界面**：`login.xml`
- **主界面**：`main.xml`
- **浏览界面**：`explore.xml`
- **管理界面**：`admin-*.xml`
- **媒体播放器**：`mediaplayer.xml`

### 6. 认证服务 (`libs/services/auth/`)

#### 支持的认证后端
1. **Internal**：内部数据库（Bcrypt 哈希）
2. **PAM**：Linux PAM 认证
3. **HTTP Headers**：反向代理 SSO

#### 功能
- 用户登录/登出
- Token 管理
- 密码加密（Bcrypt）
- 登录限流（防止暴力破解）

### 7. Subsonic API (`libs/subsonic/`)

#### 职责
- 实现 Subsonic/OpenSubsonic API
- 兼容多种音乐客户端
- RESTful API 端点

#### 支持的客户端
- DSub, Subsonic Player, Symfonium, Tempo, Tempus, Ultrasonic

---

## 学习计划

### 阶段 0：环境准备（1-2 天）

#### 目标
搭建开发环境，理解项目构建流程

#### 任务清单

**1. 安装基础工具**
```bash
# Windows (使用 WSL 或 MSYS2)
# 或直接在 Linux 环境中开发

# 必需工具
- C++20 编译器 (GCC 11+ 或 Clang 14+)
- CMake 3.12+
- Git
- pkg-config
```

**2. 安装依赖库**
```bash
# Debian/Ubuntu 示例
sudo apt-get install \
  build-essential \
  cmake \
  libboost-program-options-dev \
  libboost-system-dev \
  libavutil-dev \
  libavformat-dev \
  libstb-dev \
  libconfig++-dev \
  ffmpeg \
  libtag-dev \
  libpam0g-dev \
  libpugixml-dev \
  libgtest-dev \
  libarchive-dev \
  libxxhash-dev \
  libssl-dev
```

**3. 安装 Wt 框架**
- Wt 不在标准仓库中，需要从源码编译
- 参考：https://www.webtoolkit.eu/wt/doc/reference/html/InstallationUnix.html

**4. 克隆和构建项目**
```bash
git clone https://github.com/epoupon/lms.git
cd lms
mkdir build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Debug
make -j$(nproc)
```

**5. 理解构建系统**
- 阅读 `CMakeLists.txt`
- 理解库依赖关系
- 了解编译选项

#### 学习重点
- CMake 基础语法
- C++20 特性
- 依赖管理

---

### 阶段 1：理解核心概念（3-5 天）

#### 目标
理解项目的基本架构和核心概念

#### 任务清单

**1. 阅读主程序入口**
- 文件：`src/lms/main.cpp`
- 理解：
  - 程序启动流程
  - 服务初始化顺序
  - 配置加载
  - Web 服务器启动

**2. 理解配置系统**
- 文件：`conf/lms.conf`
- 阅读：`libs/core/include/core/IConfig.hpp`
- 理解：
  - 配置文件的格式
  - 配置项的读取方式
  - 默认值处理

**3. 理解日志系统**
- 文件：`libs/core/include/core/ILogger.hpp`
- 理解：
  - 日志级别
  - 日志输出位置
  - 日志格式

**4. 理解数据库架构**
- 阅读：`libs/database/include/database/IDb.hpp`
- 阅读：`libs/database/include/database/Session.hpp`
- 查看数据对象：`libs/database/include/database/objects/`
- 理解：
  - 数据库连接池
  - ORM 映射
  - 事务处理

**5. 理解服务架构**
- 查看：`libs/services/` 下的各个服务
- 理解：
  - 服务接口设计
  - 服务依赖关系
  - 服务生命周期

#### 实践任务
1. 修改日志级别，观察输出
2. 查看数据库文件结构（使用 sqlite3 工具）
3. 阅读一个简单的服务实现（如 artwork）

---

### 阶段 2：音频文件处理（5-7 天）

#### 目标
理解如何读取和处理音频文件

#### 任务清单

**1. 理解音频文件接口**
- 文件：`libs/audio/include/audio/IAudioFileInfo.hpp`
- 理解：
  - 音频属性（时长、比特率、采样率）
  - 标签读取
  - 图像提取

**2. 学习 TagLib 使用**
- 文件：`libs/audio/impl/taglib/`
- 理解：
  - 如何打开音频文件
  - 如何读取标签（artist, album, title, etc.）
  - 如何处理多值标签

**3. 学习 FFmpeg 集成**
- 文件：`libs/audio/impl/ffmpeg/`
- 理解：
  - FFmpeg API 使用
  - 音频属性读取
  - 错误处理

**4. 理解音频解析流程**
- 文件：`libs/audio/impl/ParseAudioFileInfo.cpp`
- 理解：
  - 文件格式检测
  - 解析器选择（TagLib vs FFmpeg）
  - 异常处理

#### 实践任务
1. 编写一个简单的程序，读取一个 MP3 文件的标签
2. 尝试读取不同格式的音频文件（FLAC, OGG, etc.）
3. 提取嵌入的专辑封面

---

### 阶段 3：文件扫描系统（7-10 天）

#### 目标
理解如何扫描文件系统并导入音乐

#### 任务清单

**1. 理解扫描服务接口**
- 文件：`libs/services/scanner/include/services/scanner/IScannerService.hpp`
- 理解：
  - 扫描请求
  - 扫描状态
  - 扫描事件

**2. 学习文件系统遍历**
- 查看扫描器实现
- 理解：
  - 递归目录遍历
  - 文件过滤（音频扩展名）
  - 符号链接处理

**3. 理解元数据提取和匹配**
- 理解：
  - 如何从文件路径推断信息
  - 如何匹配艺术家和专辑
  - 如何处理重复和变体

**4. 理解数据库更新**
- 理解：
  - 如何创建/更新 Track 对象
  - 如何关联 Artist 和 Release
  - 如何处理标签（Cluster）

**5. 学习扫描配置**
- 理解：
  - 媒体库配置
  - 扫描选项
  - 标签分隔符

#### 实践任务
1. 创建一个测试音乐库（几个 MP3 文件）
2. 手动触发扫描，观察日志
3. 检查数据库中的记录
4. 修改扫描配置，观察效果

---

### 阶段 4：数据库设计（5-7 天）

#### 目标
深入理解数据库设计和 ORM 使用

#### 任务清单

**1. 理解数据模型**
- 阅读所有 `libs/database/include/database/objects/*.hpp`
- 理解：
  - Track, Artist, Release, Medium 的关系
  - 多对多关系（Track-Artist）
  - 用户相关数据（PlayQueue, TrackList）

**2. 学习 Wt::Dbo ORM**
- 理解：
  - 对象映射
  - 关系定义
  - 查询语法

**3. 理解数据库迁移**
- 文件：`libs/database/impl/Migration.cpp`
- 理解：
  - 版本管理
  - 迁移脚本
  - 数据完整性

**4. 学习查询优化**
- 理解：
  - 索引设计
  - 查询计划
  - 性能优化

#### 实践任务
1. 编写一个查询，获取某个艺术家的所有专辑
2. 编写一个查询，获取最近播放的曲目
3. 分析一个复杂查询的执行计划

---

### 阶段 5：Web UI 基础（7-10 天）

#### 目标
理解 Wt 框架和 UI 构建

#### 任务清单

**1. 学习 Wt 基础**
- 理解：
  - Wt 应用生命周期
  - Widget 系统
  - 信号和槽
  - 会话管理

**2. 理解 UI 结构**
- 文件：`src/lms/ui/LmsApplication.hpp`
- 理解：
  - 应用初始化
  - 页面路由
  - 状态管理

**3. 学习 XML 模板**
- 查看：`approot/*.xml`
- 理解：
  - Wt XML 模板语法
  - 数据绑定
  - 国际化（i18n）

**4. 理解客户端交互**
- 文件：`docroot/js/mediaplayer.js`
- 理解：
  - JavaScript 与服务器通信
  - AJAX 请求
  - 实时更新

#### 实践任务
1. 创建一个简单的 Wt 应用
2. 添加一个简单的页面
3. 实现一个简单的表单提交

---

### 阶段 6：核心功能实现（10-15 天）

#### 目标
实现基本的音乐播放功能

#### 任务清单

**1. 实现文件服务**
- 理解：
  - 如何提供音频文件下载
  - HTTP 范围请求（Range Request）
  - MIME 类型处理

**2. 实现播放队列**
- 理解：
  - PlayQueue 数据结构
  - 队列管理（添加、删除、重排）
  - 播放状态

**3. 实现媒体播放器**
- 理解：
  - HTML5 音频播放
  - 播放控制（播放、暂停、下一首）
  - 进度条更新

**4. 实现转码服务**
- 理解：
  - FFmpeg 子进程调用
  - 实时转码流
  - 格式选择

#### 实践任务
1. 实现一个简单的文件下载端点
2. 实现播放队列的添加功能
3. 实现基本的播放控制

---

### 阶段 7：高级功能（10-15 天）

#### 目标
实现推荐、搜索等高级功能

#### 任务清单

**1. 实现搜索功能**
- 理解：
  - 全文搜索
  - 搜索算法
  - 结果排序

**2. 实现推荐系统**
- 文件：`libs/services/recommendation/`
- 理解：
  - 基于标签的推荐
  - 相似度计算
  - SOM（自组织映射）算法

**3. 实现播放记录**
- 理解：
  - Listen 数据模型
  - 播放统计
  - 最近播放列表

**4. 实现用户管理**
- 理解：
  - 用户创建/编辑
  - 权限管理
  - 认证流程

---

### 阶段 8：API 实现（7-10 天）

#### 目标
理解并扩展 Subsonic API

#### 任务清单

**1. 理解 Subsonic API**
- 文件：`SUBSONIC.md`
- 理解：
  - API 端点
  - 请求/响应格式
  - 认证机制

**2. 学习 API 实现**
- 文件：`libs/subsonic/impl/`
- 理解：
  - 端点实现
  - 参数解析
  - 响应生成

**3. 实现新端点**
- 实践：添加一个简单的自定义端点

---

## 学习建议

### 1. 循序渐进
- 不要一开始就试图理解整个项目
- 从一个模块开始，逐步深入
- 先理解接口，再理解实现

### 2. 动手实践
- 每学一个概念，就写代码验证
- 修改代码，观察效果
- 遇到问题，先尝试自己解决

### 3. 阅读代码
- 从简单的模块开始（如 core）
- 理解设计模式（接口、工厂、服务定位器）
- 注意错误处理和边界情况

### 4. 使用工具
- **调试器**：GDB/LLDB
- **数据库工具**：sqlite3 命令行
- **日志**：仔细阅读日志输出
- **代码搜索**：使用 grep/ripgrep 查找函数调用

### 5. 参考文档
- Wt 文档：https://www.webtoolkit.eu/wt/doc/
- TagLib 文档：https://taglib.org/
- FFmpeg 文档：https://ffmpeg.org/documentation.html
- CMake 文档：https://cmake.org/documentation/

### 6. 社区资源
- GitHub Issues：了解常见问题
- Discussions：参与讨论
- 代码审查：学习代码风格和最佳实践

---

## 常见问题

### Q: 我应该从哪里开始？
**A**: 建议从 `main.cpp` 开始，理解程序启动流程，然后逐步深入到各个模块。

### Q: 如何调试？
**A**: 
1. 使用日志系统（设置 `log-min-severity = "debug"`）
2. 使用 GDB 调试器
3. 使用数据库工具查看数据

### Q: 如何添加新功能？
**A**: 
1. 理解现有架构
2. 找到合适的模块
3. 遵循现有的代码风格
4. 添加测试

### Q: 性能如何优化？
**A**: 
1. 使用数据库索引
2. 优化查询
3. 使用缓存（封面缓存）
4. 并行处理（扫描）

---

## 下一步

现在你已经有了完整的项目分析。建议你：

1. **立即开始阶段 0**：搭建开发环境
2. **准备学习材料**：安装必要的工具和依赖
3. **开始阅读代码**：从 `main.cpp` 开始

记住：**学习编程最好的方式就是动手实践！**

祝你学习顺利！🎵

