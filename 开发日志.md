# LMS 开发日志

## 项目概述

本项目是从零开始学习并构建 Lightweight Music Server (LMS) 音乐流媒体服务器的完整开发过程记录。

**开发模式**：参考模板项目，但不直接复制代码，完全手写实现  
**开发语言**：C++20  
**构建系统**：CMake  
**开发环境**：WSL2 (Windows Subsystem for Linux)

---

## 开发阶段记录

### 阶段 0：环境搭建（已完成 ✅）

**时间**：项目启动初期

**完成内容**：
1. 创建项目目录结构
2. 配置 WSL2 开发环境
3. 安装 Wt 框架（C++ Web Toolkit）
4. 配置 pkg-config 路径
5. 解决 Wt 图像实现依赖问题（使用 STB 而非 GraphicsMagick）
6. 创建基础 CMake 配置
7. 创建 `.gitignore` 文件

**遇到的问题**：
- Wt 框架安装时找不到 GraphicsMagick → 改用 Wt 内置 STB 图像实现
- pkg-config 找不到 Wt → 手动创建 `wt.pc` 文件并配置路径

**关键文件**：
- `scripts/install-wt.sh` - Wt 安装脚本
- `scripts/complete-wt-setup.sh` - Wt 完整配置脚本
- `scripts/configure-project.sh` - 项目配置脚本
- `.envrc` - 环境变量配置

---

### 阶段 1：Core 库基础（已完成 ✅）

**时间**：环境搭建后

**目标**：实现核心工具类和基础功能

#### 1.1 Path 工具类

**设计思路**（参考模板）：
- 使用命名空间 `lms::core::pathUtils` 组织工具函数
- 使用 `std::filesystem` 进行路径操作
- 提供文件扩展名检查、路径验证、路径清理等功能

**实现内容**：
- `hasFileAnyExtension()` - 检查文件是否有指定扩展名
- `isPathInRootPath()` - 验证路径是否在根路径内
- `getLongestCommonPath()` - 获取最长公共路径
- `sanitizeFileStem()` - 清理文件名（移除非法字符）

**文件**：
- `src/libs/core/include/core/Path.hpp`
- `src/libs/core/impl/Path.cpp`
- `src/libs/core/test/test_path.cpp`

**测试结果**：✅ 所有测试通过

#### 1.2 String 工具类

**设计思路**（参考模板）：
- 使用命名空间 `lms::core::stringUtils` 组织工具函数
- 使用 `std::string_view` 提高性能
- 提供字符串分割、连接、修剪、大小写转换等功能

**实现内容**：
- `splitString()` - 分割字符串
- `joinStrings()` - 连接字符串
- `trimString()` - 修剪字符串
- `stringToLower()` / `stringToUpper()` - 大小写转换
- `stringCaseInsensitiveEqual()` - 大小写不敏感比较
- `capitalize()` - 首字母大写

**文件**：
- `src/libs/core/include/core/String.hpp`
- `src/libs/core/impl/String.cpp`
- `src/libs/core/test/test_string.cpp`

**测试结果**：✅ 所有测试通过

#### 1.3 Random 工具类

**设计思路**（参考模板）：
- 使用命名空间 `lms::core::random` 组织工具函数
- 使用 `thread_local` 确保线程安全
- 提供随机数生成、容器打乱、随机选择等功能

**实现内容**：
- `getRandGenerator()` - 获取线程局部随机数生成器
- `createSeededGenerator()` - 创建带种子的生成器
- `getRandom()` - 生成随机整数（模板函数）
- `getRealRandom()` - 生成随机浮点数（模板函数）
- `shuffleContainer()` - 打乱容器（模板函数）
- `pickRandom()` - 从容器中随机选择（模板函数）

**文件**：
- `src/libs/core/include/core/Random.hpp`
- `src/libs/core/impl/Random.cpp`

**测试结果**：✅ 所有测试通过

#### 1.4 UUID 类

**设计思路**（参考模板）：
- 使用类封装 UUID 功能
- 实现 UUID v4 标准
- 使用正则表达式验证 UUID 格式

**实现内容**：
- `UUID::fromString()` - 从字符串解析 UUID
- `UUID::generate()` - 生成 UUID v4
- `getAsString()` - 获取字符串表示
- 比较操作符（使用 C++20 的 `operator<=>`）

**文件**：
- `src/libs/core/include/core/UUID.hpp`
- `src/libs/core/impl/UUID.cpp`
- `src/libs/core/test/test_uuid.cpp`

**遇到的问题**：
- 初始实现 UUID v4 时，版本位和变体位设置不正确 → 修复为符合 UUID v4 标准

**测试结果**：✅ 所有测试通过

**Git 提交**：
- `feat: 实现Path工具类完整功能`
- `feat: 实现String工具类完整功能`
- `feat: 实现Random和UUID生成功能`

---

### 阶段 2：配置和日志系统（已完成 ✅）

**时间**：Core 库基础完成后

#### 2.1 配置系统 (IConfig)

**设计思路**（参考模板）：
- 使用接口 `IConfig` 定义配置访问抽象
- 使用 `libconfig++` 库解析配置文件
- 实现 `Config` 类作为具体实现
- 支持多种类型：string, path, unsigned long, long, bool
- 支持多值字符串配置（数组）

**实现内容**：
- `IConfig` 接口定义
- `Config` 类实现
- `getString()` - 获取字符串配置
- `getPath()` - 获取路径配置
- `getULong()` / `getLong()` - 获取整数配置
- `getBool()` - 获取布尔配置
- `visitStrings()` - 访问多值字符串配置

**文件**：
- `src/libs/core/include/core/IConfig.hpp`
- `src/libs/core/impl/Config.hpp`
- `src/libs/core/impl/Config.cpp`
- `src/libs/core/test/test_config.cpp`
- `conf/lms.conf` - 配置文件示例

**测试结果**：✅ 所有测试通过

#### 2.2 Service 模式

**设计思路**（参考模板）：
- 实现服务定位器模式
- 使用模板类 `Service<T>` 管理全局服务
- 支持依赖注入
- 使用静态成员存储服务实例

**实现内容**：
- `Service` 模板类
- `get()` - 获取服务实例
- `assign()` - 注册服务实例
- `exists()` - 检查服务是否存在

**文件**：
- `src/libs/core/include/core/Service.hpp`

#### 2.3 日志系统 (ILogger)

**设计思路**（参考模板）：
- 使用接口 `ILogger` 定义日志抽象
- 实现 `Logger` 类支持文件和控制台输出
- 使用 `Log` 类构建日志消息（RAII 模式）
- 支持多个严重级别：FATAL, ERROR, WARNING, INFO, DEBUG
- 支持多个模块标识
- 线程安全的日志输出

**实现内容**：
- `ILogger` 接口定义
- `Logger` 类实现
- `Log` 类（RAII 模式）
- `getModuleName()` / `getSeverityName()` - 名称转换函数
- `LMS_LOG` / `LMS_LOG_IF` - 日志宏

**遇到的问题**：
- `DEBUG` 是预定义宏，与枚举值冲突 → 使用 `DEBUG_LEVEL` 并定义宏别名

**文件**：
- `src/libs/core/include/core/ILogger.hpp`
- `src/libs/core/impl/Logger.hpp`
- `src/libs/core/impl/Logger.cpp`
- `src/libs/core/test/test_logger.cpp`

**测试结果**：✅ 所有测试通过

**Git 提交**（准备中）：
- `feat: 实现配置系统(IConfig)`
- `feat: 实现日志系统(ILogger)和Service模式`

---

### 阶段 3：数据库基础（进行中 🚧）

**时间**：配置和日志系统完成后

**目标**：实现数据库访问层，使用 Wt::Dbo ORM 框架

#### 3.1 数据库基础架构（已完成 ✅）

**设计思路**（参考模板）：
- 使用 `IDb` 接口定义数据库抽象
- 使用 `Session` 类封装 Wt::Dbo::Session
- 实现 `Transaction` 类管理事务（ReadTransaction, WriteTransaction）
- 使用 `Object` 模板基类定义数据对象
- 使用 `IdType` 和 `TaggedType` 实现强类型 ID

**实现内容**：
- `IDb` 接口定义
- `Db` 类实现（连接池、TLS 会话管理）
- `Session` 类实现（表映射、查询方法）
- `Transaction` 类（ReadTransaction, WriteTransaction）
- `Object` 模板基类
- `ObjectPtr` 模板类
- `IdType` 和 `TaggedType` 支持
- `Types.hpp` - Range, RangeResults 等类型定义

**文件**：
- `src/libs/database/include/database/IDb.hpp`
- `src/libs/database/impl/Db.hpp`
- `src/libs/database/impl/Db.cpp`
- `src/libs/database/include/database/Session.hpp`
- `src/libs/database/impl/Session.cpp`
- `src/libs/database/include/database/Transaction.hpp`
- `src/libs/database/impl/Transaction.cpp`
- `src/libs/database/include/database/Object.hpp`
- `src/libs/database/impl/Object.cpp`
- `src/libs/database/include/database/IdType.hpp`
- `src/libs/core/include/core/TaggedType.hpp`
- `src/libs/database/include/database/Types.hpp`
- `src/libs/database/CMakeLists.txt`

**遇到的问题**：
1. Wt::Dbo::Transaction 构造函数不接受第二个参数 → 修复为只传 Session 引用
2. Object 类中 `IdType` 与命名空间中的 `IdType` 类名冲突 → 改为 `ObjectId`
3. Session::execute() 方法不存在 → 改为通过 Db 类执行 SQL

**测试结果**：✅ 编译通过

**当前进度**：60% 完成

#### 3.2 下一步工作（待实现）

1. **Db 类实现**
   - 连接池管理
   - TLS 会话管理
   - SQLite 连接配置

2. **Session 完整功能**
   - 表映射（mapClass）
   - 查询方法
   - 数据库初始化

3. **User 数据对象**
   - 实现第一个数据模型
   - 用户认证相关字段

4. **数据库迁移系统**
   - 版本管理
   - 迁移脚本

---

## 技术决策记录

### 1. Wt 图像实现选择

**问题**：Wt 框架默认使用 GraphicsMagick，但安装复杂  
**决策**：使用 Wt 内置的 STB 图像实现（`WT_WRASTERIMAGE_IMPLEMENTATION=Wt`）  
**原因**：减少外部依赖，简化部署

### 2. UUID v4 实现

**问题**：初始实现不符合 UUID v4 标准  
**决策**：严格按照 UUID v4 规范实现版本位和变体位  
**原因**：确保生成的 UUID 符合标准，可被其他系统识别

### 3. DEBUG 宏冲突

**问题**：`DEBUG` 是预定义宏，与日志严重级别枚举冲突  
**决策**：使用 `DEBUG_LEVEL` 作为枚举值，并定义宏别名  
**原因**：保持代码可读性，同时避免宏冲突

### 4. 数据库 ORM 选择

**决策**：使用 Wt::Dbo ORM 框架  
**原因**：
- 模板项目使用此框架
- 与 Wt Web 框架集成良好
- 支持 SQLite（适合轻量级服务器）

---

## 学习收获

### 1. C++20 特性应用

- `std::string_view` - 高效字符串处理
- `std::filesystem` - 文件系统操作
- `std::span` - 数组视图
- `operator<=>` - 三路比较运算符
- `thread_local` - 线程局部存储

### 2. 设计模式应用

- **工具函数命名空间模式** - Path, String 工具类
- **接口/实现分离** - IConfig, ILogger
- **服务定位器模式** - Service 模板类
- **RAII 模式** - Log 类、Transaction 类
- **模板元编程** - Object 基类、TaggedType

### 3. CMake 最佳实践

- 模块化 CMakeLists.txt
- 正确的依赖管理
- 测试目标配置

### 4. 开发流程

- 渐进式 Git 提交
- 测试驱动开发
- 从简单到复杂的实现顺序

---

## 待解决问题

1. **数据库连接池配置** - 需要实现 Db 类的完整功能
2. **数据库迁移系统** - 需要设计版本管理机制
3. **事务检查机制** - 需要实现 TransactionChecker（调试模式）

---

## 下一步计划

1. 完成 Db 类实现（连接池、TLS 会话）
2. 完成 Session 完整功能（表映射、查询）
3. 实现 User 数据对象
4. 实现数据库迁移系统
5. 集成测试

---

**最后更新**：2025-11-22  
**当前阶段**：阶段 3 - 数据库基础（30%）

